{'role': 'assistant', 'content': '\n<function_calls>\n<create-file file_path="src/hooks/useAI.ts">\nimport { useState, useCallback, useEffect } from \'react\';\nimport { useAIServicesStore } from \'@/store\';\nimport { AIRequest, AIResponse, AIService } from \'@/types\';\n\nexport const useAI = () => {\n  const {\n    services,\n    activeService,\n    isProcessing,\n    lastResponse,\n    loadServices,\n    setActiveService: storeSetActiveService,\n    processRequest: storeProcessRequest,\n  } = useAIServicesStore();\n\n  const [conversationHistory, setConversationHistory] = useState<Array<{\n    role: \'user\' | \'assistant\';\n    content: string;\n    timestamp: Date;\n    service?: string;\n  }>>([]);\n\n  const [streamingResponse, setStreamingResponse] = useState<string>(\'\');\n  const [isStreaming, setIsStreaming] = useState(false);\n\n  useEffect(() => {\n    loadServices();\n  }, [loadServices]);\n\n  const setActiveService = useCallback((service: AIService | null) => {\n    storeSetActiveService(service);\n    setConversationHistory([]);\n  }, [storeSetActiveService]);\n\n  const sendMessage = useCallback(async (message: string, options?: {\n    context?: string;\n    temperature?: number;\n    maxTokens?: number;\n  }) => {\n    if (!activeService || !message.trim()) return;\n\n    const userMessage = {\n      role: \'user\' as const,\n      content: message,\n      timestamp: new Date(),\n      service: activeService.id,\n    };\n\n    setConversationHistory(prev => [...prev, userMessage]);\n\n    try {\n      setIsStreaming(true);\n      setStreamingResponse(\'\');\n\n      const request: AIRequest = {\n        message,\n        serviceId: activeService.id,\n        context: options?.context,\n        temperature: options?.temperature || 0.7,\n        maxTokens: options?.maxTokens || 1000,\n        stream: true,\n      };\n\n      const response = await storeProcessRequest(request);\n\n      // Handle streaming response\n      if (response.stream) {\n        for await (const chunk of response.stream) {\n          setStreamingResponse(prev => prev + chunk);\n        }\n      }\n\n      const assistantMessage = {\n        role: \'assistant\' as const,\n        content: response.content || streamingResponse,\n        timestamp: new Date(),\n        service: activeService.id,\n      };\n\n      setConversationHistory(prev => [...prev, assistantMessage]);\n    } catch (error) {\n      console.error(\'AI request failed:\', error);\n      \n      const errorMessage = {\n        role: \'assistant\' as const,\n        content: options?.context?.includes(\'ar\') \n          ? \'عذراً، حدث خطأ. يرجى المحاولة مرة أخرى.\' \n          : \'Sorry, an error occurred. Please try again.\',\n        timestamp: new Date(),\n        service: activeService.id,\n      };\n\n      setConversationHistory(prev => [...prev, errorMessage]);\n    } finally {\n      setIsStreaming(false);\n      setStreamingResponse(\'\');\n    }\n  }, [activeService, storeProcessRequest, streamingResponse]);\n\n  const clearConversation = useCallback(() => {\n    setConversationHistory([]);\n  }, []);\n\n  const exportConversation = useCallback(() => {\n    const data = {\n      service: activeService?.name || \'Unknown\',\n      messages: conversationHistory,\n      exportDate: new Date().toISOString(),\n    };\n\n    const blob = new Blob([JSON.stringify(data, null, 2)], { type: \'application/json\' });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement(\'a\');\n    a.href = url;\n    a.download = `ai-conversation-${Date.now()}.json`;\n    a.click();\n    URL.revokeObjectURL(url);\n  }, [activeService, conversationHistory]);\n\n  const generateImage = useCallback(async (prompt: string, options?: {\n    width?: number;\n    height?: number;\n    style?: string;\n  }) => {\n    if (!activeService || !activeService.capabilities?.includes(\'image_generation\')) {\n      throw new Error(\'Current service does not support image generation\');\n    }\n\n    const request: AIRequest = {\n      message: prompt,\n      serviceId: activeService.id,\n      type: \'image_generation\',\n      parameters: {\n        width: options?.width || 512,\n        height: options?.height || 512,\n        style: options?.style || \'realistic\',\n      },\n    };\n\n    return await storeProcessRequest(request);\n  }, [activeService, storeProcessRequest]);\n\n  const transcribeAudio = useCallback(async (audioFile: File) => {\n    if (!activeService || !activeService.capabilities?.includes(\'speech_to_text\')) {\n      throw new Error(\'Current service does not support speech to text\');\n    }\n\n    const formData = new FormData();\n    formData.append(\'audio\', audioFile);\n    formData.append(\'serviceId\', activeService.id);\n\n    const response = await fetch(\'/api/ai/transcribe\', {\n      method: \'POST\',\n      body: formData,\n    });\n\n    if (!response.ok) {\n      throw new Error(\'Transcription failed\');\n    }\n\n    return await response.json();\n  }, [activeService]);\n\n  const generateSpeech = useCallback(async (text: string, options?: {\n    voice?: string;\n    speed?: number;\n    language?: string;\n  }) => {\n    if (!activeService || !activeService.capabilities?.includes(\'text_to_speech\')) {\n      throw new Error(\'Current service does not support text to speech\');\n    }\n\n    const request: AIRequest = {\n      message: text,\n      serviceId: activeService.id,\n      type: \'text_to_speech\',\n      parameters: {\n        voice: options?.voice || \'default\',\n        speed: options?.speed || 1.0,\n        language: options?.language || \'en\',\n      },\n    };\n\n    return await storeProcessRequest(request);\n  }, [activeService, storeProcessRequest]);\n\n  // Auto-cleanup old messages\n  useEffect(() => {\n    if (conversationHistory.length > 100) {\n      setConversationHistory(prev => prev.slice(-50)); // Keep last 50 messages\n    }\n  }, [conversationHistory]);\n\n  return {\n    // State\n    services,\n    activeService,\n    isProcessing,\n    lastResponse,\n    conversationHistory,\n    streamingResponse,\n    isStreaming,\n\n    // Actions\n    setActiveService,\n    sendMessage,\n    clearConversation,\n    exportConversation,\n    generateImage,\n    transcribeAudio,\n    generateSpeech,\n  };\n};\n</create-file>\n</function_calls>'}