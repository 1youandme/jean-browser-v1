{'role': 'assistant', 'content': '\n<function_calls>\n<create-file file_path="src/services/loyaltywallet.ts">\n// Loyalty Wallet Service Interface and Implementation\nexport interface LoyaltyWallet {\n  id: string;\n  userId: string;\n  balance: number;\n  currency: string;\n  points: number;\n  tier: LoyaltyTier;\n  memberSince: Date;\n  lastActivity: Date;\n  settings: WalletSettings;\n}\n\nexport interface LoyaltyTier {\n  name: string;\n  level: number;\n  benefits: string[];\n  pointMultiplier: number;\n  cashbackRate: number;\n  requiredPoints: number;\n  nextTier?: LoyaltyTier;\n}\n\nexport interface WalletSettings {\n  notifications: boolean;\n  emailUpdates: boolean;\n  autoRedeem: boolean;\n  preferredRedemption: RedemptionType;\n}\n\nexport interface LoyaltyProgram {\n  id: string;\n  name: string;\n  description: string;\n  merchant: Merchant;\n  type: \'points\' | \'cashback\' | \'tiered\' | \'hybrid\';\n  currency: string;\n  conversionRate: number;\n  expirationPolicy: ExpirationPolicy;\n  benefits: ProgramBenefit[];\n  isActive: boolean;\n  createdAt: Date;\n}\n\nexport interface Merchant {\n  id: string;\n  name: string;\n  category: string;\n  logo?: string;\n  website?: string;\n  locations: MerchantLocation[];\n}\n\nexport interface MerchantLocation {\n  id: string;\n  address: Address;\n  coordinates: {\n    lat: number;\n    lng: number;\n  };\n  phone?: string;\n  hours: string;\n}\n\nexport interface Address {\n  street: string;\n  city: string;\n  state: string;\n  zipCode: string;\n  country: string;\n}\n\nexport interface ExpirationPolicy {\n  type: \'fixed\' | \'rolling\' | \'none\';\n  duration?: number; // in days\n  fixedDate?: Date;\n}\n\nexport interface ProgramBenefit {\n  id: string;\n  type: \'discount\' | \'freebie\' | \'upgrade\' | \'cashback\' | \'points\';\n  title: string;\n  description: string;\n  value: number;\n  requiredTier?: string;\n  conditions?: string[];\n  isActive: boolean;\n}\n\nexport interface Transaction {\n  id: string;\n  walletId: string;\n  programId: string;\n  type: \'earn\' | \'redeem\' | \'expire\' | \'adjustment\';\n  amount: number;\n  points?: number;\n  description: string;\n  referenceId?: string;\n  merchant?: string;\n  location?: string;\n  status: \'pending\' | \'completed\' | \'failed\' | \'cancelled\';\n  metadata: Record<string, any>;\n  createdAt: Date;\n  processedAt?: Date;\n  expiresAt?: Date;\n}\n\nexport interface Redemption {\n  id: string;\n  walletId: string;\n  programId: string;\n  type: RedemptionType;\n  amount: number;\n  pointsUsed: number;\n  description: string;\n  status: \'pending\' | \'approved\' | \'rejected\' | \'completed\' | \'expired\';\n  redemptionCode?: string;\n  instructions?: string;\n  restrictions?: string[];\n  createdAt: Date;\n  expiresAt?: Date;\n  redeemedAt?: Date;\n}\n\nexport type RedemptionType = \n  | \'gift_card\'\n  | \'discount_coupon\'\n  | \'free_product\'\n  | \'cash\'\n  | \'charity\'\n  | \'experience\'\n  | \'upgrade\';\n\nexport interface Reward {\n  id: string;\n  programId: string;\n  name: string;\n  description: string;\n  type: RedemptionType;\n  cost: number;\n  value: number;\n  imageUrl?: string;\n  termsAndConditions?: string;\n  availability: {\n    total: number;\n    remaining: number;\n    restrictions?: string[];\n  };\n  popularity: number;\n  category: string;\n  isActive: boolean;\n  createdAt: Date;\n  validUntil?: Date;\n}\n\nexport interface Promotion {\n  id: string;\n  programId: string;\n  name: string;\n  description: string;\n  type: \'bonus\' | \'multiplier\' | \'cashback\' | \'freebie\';\n  multiplier?: number;\n  bonusPoints?: number;\n  cashbackRate?: number;\n  conditions: PromotionCondition[];\n  startDate: Date;\n  endDate: Date;\n  isActive: boolean;\n  maxUsage?: number;\n  currentUsage: number;\n  targetAudience?: string[];\n}\n\nexport interface PromotionCondition {\n  type: \'spend\' | \'visit\' | \'category\' | \'product\' | \'time\' | \'location\';\n  operator: \'equals\' | \'greater_than\' | \'less_than\' | \'between\';\n  value: any;\n  description: string;\n}\n\nexport interface LoyaltyWalletService {\n  // Wallet management\n  getWallet: () => Promise<LoyaltyWallet>;\n  updateWalletSettings: (settings: Partial<WalletSettings>) => Promise<LoyaltyWallet>;\n  getWalletBalance: () => Promise<{ balance: number; points: number; currency: string }>;\n  \n  // Program management\n  getPrograms: () => Promise<LoyaltyProgram[]>;\n  getProgram: (id: string) => Promise<LoyaltyProgram>;\n  joinProgram: (programId: string) => Promise<void>;\n  leaveProgram: (programId: string) => Promise<void>;\n  getActivePrograms: () => Promise<LoyaltyProgram[]>;\n  \n  // Transaction management\n  getTransactions: (filters?: TransactionFilters) => Promise<Transaction[]>;\n  getTransaction: (id: string) => Promise<Transaction>;\n  getTransactionHistory: (limit?: number, offset?: number) => Promise<{ transactions: Transaction[]; total: number }>;\n  \n  // Points and rewards\n  getRewards: (programId?: string) => Promise<Reward[]>;\n  getReward: (id: string) => Promise<Reward>;\n  redeemReward: (rewardId: string, quantity?: number) => Promise<Redemption>;\n  getRedemptions: (status?: Redemption[\'status\']) => Promise<Redemption[]>;\n  getRedemption: (id: string) => Promise<Redemption>;\n  cancelRedemption: (redemptionId: string) => Promise<void>;\n  \n  // Promotions\n  getPromotions: (programId?: string) => Promise<Promotion[]>;\n  getPromotion: (id: string) => Promise<Promotion>;\n  activatePromotion: (promotionId: string) => Promise<void>;\n  \n  // Analytics and insights\n  getEarningsSummary: (timeRange?: string) => Promise<EarningsSummary>;\n  getSpendingInsights: () => Promise<SpendingInsight[]>;\n  getTierProgress: () => Promise<TierProgress>;\n  getSavingsAnalysis: () => Promise<SavingsAnalysis>;\n  \n  // Search and discovery\n  searchMerchants: (query: string, location?: string) => Promise<Merchant[]>;\n  getNearbyMerchants: (coordinates: { lat: number; lng: number }, radius?: number) => Promise<Merchant[]>;\n  getMerchantPrograms: (merchantId: string) => Promise<LoyaltyProgram[]>;\n  \n  // Social features\n  referFriend: (email: string, message?: string) => Promise<Referral>;\n  getReferrals: () => Promise<Referral[]>;\n  shareReward: (redemptionId: string, recipient: string) => Promise<void>;\n  \n  // Notifications\n  getNotifications: () => Promise<LoyaltyNotification[]>;\n  markNotificationRead: (notificationId: string) => Promise<void>;\n  subscribeToPromotions: (programIds: string[]) => Promise<void>;\n  unsubscribeFromPromotions: (programIds: string[]) => Promise<void>;\n}\n\nexport interface TransactionFilters {\n  programId?: string;\n  type?: Transaction[\'type\'];\n  status?: Transaction[\'status\'];\n  dateRange?: {\n    from: Date;\n    to: Date;\n  };\n  amountRange?: {\n    min: number;\n    max: number;\n  };\n  merchant?: string;\n}\n\nexport interface EarningsSummary {\n  totalEarned: number;\n  totalRedeemed: number;\n  currentBalance: number;\n  pointsEarned: number;\n  pointsRedeemed: number;\n  savings: number;\n  topPrograms: Array<{\n    programId: string;\n    programName: string;\n    earned: number;\n    redeemed: number;\n  }>;\n  monthlyTrend: Array<{\n    month: string;\n    earned: number;\n    redeemed: number;\n  }>;\n}\n\nexport interface SpendingInsight {\n  category: string;\n  amount: number;\n  percentage: number;\n  trend: \'up\' | \'down\' | \'stable\';\n  recommendations: string[];\n}\n\nexport interface TierProgress {\n  currentTier: LoyaltyTier;\n  nextTier?: LoyaltyTier;\n  currentPoints: number;\n  pointsToNext: number;\n  progressPercentage: number;\n  benefitsToUnlock: string[];\n  estimatedTimeToNext: number; // in days\n}\n\nexport interface SavingsAnalysis {\n  totalSavings: number;\n  cashbackEarned: number;\n  discountValue: number;\n  freebieValue: number;\n  averageSavingsPerTransaction: number;\n  bestProgram: {\n    programId: string;\n    programName: string;\n    savings: number;\n  };\n  optimizationSuggestions: string[];\n}\n\nexport interface Referral {\n  id: string;\n  referredEmail: string;\n  status: \'pending\' | \'accepted\' | \'completed\' | \'expired\';\n  reward: {\n    points: number;\n    description: string;\n  };\n  referredAt: Date;\n  completedAt?: Date;\n  expiresAt: Date;\n}\n\nexport interface LoyaltyNotification {\n  id: string;\n  type: \'points_earned\' | \'reward_available\' | \'promotion_active\' | \'tier_upgrade\' | \'points_expiring\';\n  title: string;\n  message: string;\n  programId?: string;\n  programName?: string;\n  data?: Record<string, any>;\n  isRead: boolean;\n  createdAt: Date;\n  expiresAt?: Date;\n}\n\nclass LoyaltyWalletServiceImpl implements LoyaltyWalletService {\n  private baseUrl: string;\n\n  constructor(baseUrl: string = \'http://localhost:8080\') {\n    this.baseUrl = baseUrl;\n  }\n\n  async getWallet(): Promise<LoyaltyWallet> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/wallet`);\n    if (!response.ok) throw new Error(\'Failed to get wallet\');\n    return response.json();\n  }\n\n  async updateWalletSettings(settings: Partial<WalletSettings>): Promise<LoyaltyWallet> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/wallet/settings`, {\n      method: \'PUT\',\n      headers: { \'Content-Type\': \'application/json\' },\n      body: JSON.stringify(settings),\n    });\n    if (!response.ok) throw new Error(\'Failed to update wallet settings\');\n    return response.json();\n  }\n\n  async getWalletBalance(): Promise<{ balance: number; points: number; currency: string }> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/wallet/balance`);\n    if (!response.ok) throw new Error(\'Failed to get wallet balance\');\n    return response.json();\n  }\n\n  async getPrograms(): Promise<LoyaltyProgram[]> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/programs`);\n    if (!response.ok) throw new Error(\'Failed to get programs\');\n    return response.json();\n  }\n\n  async getProgram(id: string): Promise<LoyaltyProgram> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/programs/${id}`);\n    if (!response.ok) throw new Error(\'Failed to get program\');\n    return response.json();\n  }\n\n  async joinProgram(programId: string): Promise<void> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/programs/${programId}/join`, {\n      method: \'POST\',\n    });\n    if (!response.ok) throw new Error(\'Failed to join program\');\n  }\n\n  async leaveProgram(programId: string): Promise<void> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/programs/${programId}/leave`, {\n      method: \'POST\',\n    });\n    if (!response.ok) throw new Error(\'Failed to leave program\');\n  }\n\n  async getActivePrograms(): Promise<LoyaltyProgram[]> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/programs/active`);\n    if (!response.ok) throw new Error(\'Failed to get active programs\');\n    return response.json();\n  }\n\n  async getTransactions(filters?: TransactionFilters): Promise<Transaction[]> {\n    const params = new URLSearchParams();\n    if (filters) {\n      Object.entries(filters).forEach(([key, value]) => {\n        if (value !== undefined) {\n          if (typeof value === \'object\' && value !== null) {\n            Object.entries(value).forEach(([subKey, subValue]) => {\n              params.append(`${key}.${subKey}`, String(subValue));\n            });\n          } else {\n            params.append(key, String(value));\n          }\n        }\n      });\n    }\n\n    const response = await fetch(`${this.baseUrl}/api/loyalty/transactions?${params}`);\n    if (!response.ok) throw new Error(\'Failed to get transactions\');\n    return response.json();\n  }\n\n  async getTransaction(id: string): Promise<Transaction> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/transactions/${id}`);\n    if (!response.ok) throw new Error(\'Failed to get transaction\');\n    return response.json();\n  }\n\n  async getTransactionHistory(limit?: number, offset?: number): Promise<{ transactions: Transaction[]; total: number }> {\n    const params = new URLSearchParams();\n    if (limit) params.append(\'limit\', limit.toString());\n    if (offset) params.append(\'offset\', offset.toString());\n\n    const response = await fetch(`${this.baseUrl}/api/loyalty/transactions/history?${params}`);\n    if (!response.ok) throw new Error(\'Failed to get transaction history\');\n    return response.json();\n  }\n\n  async getRewards(programId?: string): Promise<Reward[]> {\n    const params = programId ? `?programId=${programId}` : \'\';\n    const response = await fetch(`${this.baseUrl}/api/loyalty/rewards${params}`);\n    if (!response.ok) throw new Error(\'Failed to get rewards\');\n    return response.json();\n  }\n\n  async getReward(id: string): Promise<Reward> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/rewards/${id}`);\n    if (!response.ok) throw new Error(\'Failed to get reward\');\n    return response.json();\n  }\n\n  async redeemReward(rewardId: string, quantity?: number): Promise<Redemption> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/rewards/${rewardId}/redeem`, {\n      method: \'POST\',\n      headers: { \'Content-Type\': \'application/json\' },\n      body: JSON.stringify({ quantity }),\n    });\n    if (!response.ok) throw new Error(\'Failed to redeem reward\');\n    return response.json();\n  }\n\n  async getRedemptions(status?: Redemption[\'status\']): Promise<Redemption[]> {\n    const params = status ? `?status=${status}` : \'\';\n    const response = await fetch(`${this.baseUrl}/api/loyalty/redemptions${params}`);\n    if (!response.ok) throw new Error(\'Failed to get redemptions\');\n    return response.json();\n  }\n\n  async getRedemption(id: string): Promise<Redemption> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/redemptions/${id}`);\n    if (!response.ok) throw new Error(\'Failed to get redemption\');\n    return response.json();\n  }\n\n  async cancelRedemption(redemptionId: string): Promise<void> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/redemptions/${redemptionId}/cancel`, {\n      method: \'POST\',\n    });\n    if (!response.ok) throw new Error(\'Failed to cancel redemption\');\n  }\n\n  async getPromotions(programId?: string): Promise<Promotion[]> {\n    const params = programId ? `?programId=${programId}` : \'\';\n    const response = await fetch(`${this.baseUrl}/api/loyalty/promotions${params}`);\n    if (!response.ok) throw new Error(\'Failed to get promotions\');\n    return response.json();\n  }\n\n  async getPromotion(id: string): Promise<Promotion> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/promotions/${id}`);\n    if (!response.ok) throw new Error(\'Failed to get promotion\');\n    return response.json();\n  }\n\n  async activatePromotion(promotionId: string): Promise<void> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/promotions/${promotionId}/activate`, {\n      method: \'POST\',\n    });\n    if (!response.ok) throw new Error(\'Failed to activate promotion\');\n  }\n\n  async getEarningsSummary(timeRange?: string): Promise<EarningsSummary> {\n    const params = timeRange ? `?timeRange=${timeRange}` : \'\';\n    const response = await fetch(`${this.baseUrl}/api/loyalty/analytics/earnings${params}`);\n    if (!response.ok) throw new Error(\'Failed to get earnings summary\');\n    return response.json();\n  }\n\n  async getSpendingInsights(): Promise<SpendingInsight[]> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/analytics/spending-insights`);\n    if (!response.ok) throw new Error(\'Failed to get spending insights\');\n    return response.json();\n  }\n\n  async getTierProgress(): Promise<TierProgress> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/analytics/tier-progress`);\n    if (!response.ok) throw new Error(\'Failed to get tier progress\');\n    return response.json();\n  }\n\n  async getSavingsAnalysis(): Promise<SavingsAnalysis> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/analytics/savings`);\n    if (!response.ok) throw new Error(\'Failed to get savings analysis\');\n    return response.json();\n  }\n\n  async searchMerchants(query: string, location?: string): Promise<Merchant[]> {\n    const params = new URLSearchParams({ query });\n    if (location) params.append(\'location\', location);\n\n    const response = await fetch(`${this.baseUrl}/api/loyalty/merchants/search?${params}`);\n    if (!response.ok) throw new Error(\'Failed to search merchants\');\n    return response.json();\n  }\n\n  async getNearbyMerchants(coordinates: { lat: number; lng: number }, radius?: number): Promise<Merchant[]> {\n    const params = new URLSearchParams({\n      lat: coordinates.lat.toString(),\n      lng: coordinates.lng.toString(),\n    });\n    if (radius) params.append(\'radius\', radius.toString());\n\n    const response = await fetch(`${this.baseUrl}/api/loyalty/merchants/nearby?${params}`);\n    if (!response.ok) throw new Error(\'Failed to get nearby merchants\');\n    return response.json();\n  }\n\n  async getMerchantPrograms(merchantId: string): Promise<LoyaltyProgram[]> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/merchants/${merchantId}/programs`);\n    if (!response.ok) throw new Error(\'Failed to get merchant programs\');\n    return response.json();\n  }\n\n  async referFriend(email: string, message?: string): Promise<Referral> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/referrals`, {\n      method: \'POST\',\n      headers: { \'Content-Type\': \'application/json\' },\n      body: JSON.stringify({ email, message }),\n    });\n    if (!response.ok) throw new Error(\'Failed to refer friend\');\n    return response.json();\n  }\n\n  async getReferrals(): Promise<Referral[]> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/referrals`);\n    if (!response.ok) throw new Error(\'Failed to get referrals\');\n    return response.json();\n  }\n\n  async shareReward(redemptionId: string, recipient: string): Promise<void> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/redemptions/${redemptionId}/share`, {\n      method: \'POST\',\n      headers: { \'Content-Type\': \'application/json\' },\n      body: JSON.stringify({ recipient }),\n    });\n    if (!response.ok) throw new Error(\'Failed to share reward\');\n  }\n\n  async getNotifications(): Promise<LoyaltyNotification[]> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/notifications`);\n    if (!response.ok) throw new Error(\'Failed to get notifications\');\n    return response.json();\n  }\n\n  async markNotificationRead(notificationId: string): Promise<void> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/notifications/${notificationId}/read`, {\n      method: \'POST\',\n    });\n    if (!response.ok) throw new Error(\'Failed to mark notification as read\');\n  }\n\n  async subscribeToPromotions(programIds: string[]): Promise<void> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/subscriptions/promotions`, {\n      method: \'POST\',\n      headers: { \'Content-Type\': \'application/json\' },\n      body: JSON.stringify({ programIds }),\n    });\n    if (!response.ok) throw new Error(\'Failed to subscribe to promotions\');\n  }\n\n  async unsubscribeFromPromotions(programIds: string[]): Promise<void> {\n    const response = await fetch(`${this.baseUrl}/api/loyalty/subscriptions/promotions`, {\n      method: \'DELETE\',\n      headers: { \'Content-Type\': \'application/json\' },\n      body: JSON.stringify({ programIds }),\n    });\n    if (!response.ok) throw new Error(\'Failed to unsubscribe from promotions\');\n  }\n}\n\nexport const loyaltyWalletService = new LoyaltyWalletServiceImpl();\nexport const useLoyaltyWalletService = () => loyaltyWalletService;\n</create-file>\n</function_calls>'}