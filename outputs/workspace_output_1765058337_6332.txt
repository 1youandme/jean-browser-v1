-- Jean Orchestrator Database Schema
-- Migration 003: Jean AI Core Tables

-- Jean Memory Store
CREATE TABLE jean_memory (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    memory_type VARCHAR(50) NOT NULL CHECK (memory_type IN ('conversation', 'knowledge', 'preference', 'context')),
    content JSONB NOT NULL,
    context_tags TEXT[],
    session_id VARCHAR(100),
    is_private BOOLEAN DEFAULT FALSE,
    is_archived BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes for memory table
CREATE INDEX idx_jean_memory_user_id ON jean_memory(user_id);
CREATE INDEX idx_jean_memory_type ON jean_memory(memory_type);
CREATE INDEX idx_jean_memory_tags ON jean_memory USING GIN(context_tags);
CREATE INDEX idx_jean_memory_session ON jean_memory(session_id);
CREATE INDEX idx_jean_memory_created ON jean_memory(created_at);

-- Jean Permissions System
CREATE TABLE jean_permissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    action_type VARCHAR(50) NOT NULL,
    scope VARCHAR(255) NOT NULL,
    max_amount DECIMAL(10,2),
    usage_count INTEGER DEFAULT 0,
    max_usage INTEGER,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    granted_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE
);

-- Indexes for permissions
CREATE INDEX idx_jean_permissions_user ON jean_permissions(user_id);
CREATE INDEX idx_jean_permissions_action ON jean_permissions(action_type);
CREATE INDEX idx_jean_permissions_active ON jean_permissions(is_active) WHERE is_active = TRUE;
CREATE INDEX idx_jean_permissions_expires ON jean_permissions(expires_at);

-- Jean Actions Log
CREATE TABLE jean_actions_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    session_id VARCHAR(100),
